generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Dropdown options) ---
enum UserRole {
  ADMIN
  VOLUNTARIO
  STAFF
}

enum StudentStatus {
  ATIVO
  SUSPENSO
  GRADUADO
}

enum DonorType {
  EMPRESA
  INDIVIDUAL
  ANONIMO
}

enum RequestStatus {
  PENDENTE
  APROVADO
  ENTREGUE
  CANCELADO
}

// --- MODELS ---

model Student {
  id                    String          @id @default(uuid())
  name                  String          @map("nome")
  studentNumber         String          @unique @map("numero_estudante")
  course                String          @map("curso")
  academicYear          Int             @map("ano_curricular")
  socialSecurityNumber  String?         @map("numero_seguranca_social")
  contact               String?         @map("contacto")
  email                 String          @unique @map("email")
  status                StudentStatus   @default(ATIVO) @map("status")
  password              String
  hashedRefreshToken    String?

  appointments    Appointment[]
  requests        SupportRequest[]

  @@map("estudante")
}

model User {
  id                    String          @id @default(uuid())
  name                  String          @map("nome")
  userType              UserRole        @default(VOLUNTARIO) @map("tipo_utilizador")
  contact               String?         @map("contacto")
  email                 String          @unique @map("email")
  password              String
  hashedRefreshToken    String?

  processedRequests SupportRequest[]

  @@map("utilizadores")
}

model Appointment {
  id                    String       @id @default(uuid())
  date                  DateTime  @map("data_agendada")
  notificationSent      Boolean  @default(false) @map("notificacao_enviada")
  
  studentId             String       @map("id_estudante")
  student               Student   @relation(fields: [studentId], references: [id])

  // An appointment might be linked to a specific delivery request
  request         SupportRequest?

  @@map("agendamento")
}

model ProductType {
  id          Int       @id @default(autoincrement())
  description String    @map("descricao")
  products    Product[]

  @@map("tipo_produto")
}

model Product {
  id            Int            @id @default(autoincrement())
  name          String         @map("nome_produto")
  
  typeId        Int            @map("id_tipo_produto")
  type          ProductType    @relation(fields: [typeId], references: [id])

  stockBatches  Stock[]
  donationItems DonationItem[]
  requestItems  RequestItem[]

  @@map("produto")
}

model Stock {
  id          Int       @id @default(autoincrement())
  quantity    Int       @map("quantidade")
  expiryDate  DateTime? @map("data_validade")
  location    String?   @map("localizacao") // e.g. Shelf A

  productId   Int       @map("id_produto")
  product     Product   @relation(fields: [productId], references: [id])

  @@map("stock")
}

model Donor {
  id          Int       @id @default(autoincrement())
  name        String?   @map("nome") // Nullable if anonymous
  nif         String?   @map("nif")
  type        DonorType @default(INDIVIDUAL) @map("tipo")
  contact     String?   @map("contacto")
  
  donations   Donation[]

  @@map("doador")
}

model Campaign {
  id          Int       @id @default(autoincrement())
  title       String    @map("titulo")
  description String?   @map("descricao")
  startDate   DateTime  @map("data_inicio")
  endDate     DateTime? @map("data_fim")

  donations   Donation[]

  @@map("campanha")
}

model Donation {
  id          Int       @id @default(autoincrement())
  date        DateTime  @default(now()) @map("data_doacao")
  
  donorId     Int       @map("id_doador")
  donor       Donor     @relation(fields: [donorId], references: [id])

  campaignId  Int?      @map("id_campanha")
  campaign    Campaign? @relation(fields: [campaignId], references: [id])

  items       DonationItem[]

  @@map("doacao")
}

model DonationItem {
  id          Int       @id @default(autoincrement())
  quantity    Int       @map("quantidade")
  
  donationId  Int       @map("id_doacao")
  donation    Donation  @relation(fields: [donationId], references: [id])

  productId   Int       @map("id_produto")
  product     Product   @relation(fields: [productId], references: [id])

  @@map("itens_doacao")
}

model SupportRequest {
  id          Int           @id @default(autoincrement())
  date        DateTime      @default(now()) @map("data_pedido")
  status      RequestStatus @default(PENDENTE) @map("estado")
  observation String?       @map("observacao")

  studentId   String           @map("id_estudante")
  student     Student       @relation(fields: [studentId], references: [id])

  userId      String?          @map("id_utilizador") // Staff who approved/processed it
  user        User?         @relation(fields: [userId], references: [id])

  appointmentId String?        @unique @map("id_agendamento") // Linked Appointment
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  items       RequestItem[]

  @@map("pedido_apoio")
}

model RequestItem {
  id          Int       @id @default(autoincrement())
  qtyRequested Int      @map("qtd_solicitada")
  qtyDelivered Int?     @default(0) @map("qtd_entregue")
  observation  String?  @map("observacao")

  requestId   Int       @map("id_pedido")
  request     SupportRequest @relation(fields: [requestId], references: [id])

  productId   Int       @map("id_produto")
  product     Product   @relation(fields: [productId], references: [id])

  @@map("itens_pedido")
}